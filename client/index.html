<!DOCTYPE html>
<html lang="en">
<head>
    <title>Colour Me!</title>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
    
        "use strict";

        var socket;
        var timeLeft; 
        var userName;
        var userColour;
        
        var canvas;
        var ctx;
        
        var colourBoxArray;
        var boxSize = (500/7);
        
        var gamePlaying = false;
        
        var numPlayers;
        var numPlayersReady;
        
        function init() {
            
            userColour = "#0f0";
            
            canvas = document.getElementById("gameCanvas");
            ctx = canvas.getContext("2d");
            
            //set up the box array so that all boxes are white
            colourBoxArray = new Array(7);
            for(var x = 0; x < 7; x++){
                colourBoxArray[x] = new Array(7);
                for(var y = 0; y < 7; y++){
                    colourBoxArray[x][y] = "#fff";
                }
            }
            
            canvas.onclick = HandleBoxClick;
            
            setInterval(Update, 17);
            
            SocketSetUp();
            
            document.getElementById("colourPreview").style.backgroundColor = userColour;
        
            document.getElementById("readyUpBtn").onclick = (function(){
                socket.emit('readyUp'); 
                document.getElementById("readyUpBtn").disabled = true;
            });
        }
        
        
        function SocketSetUp(){
            socket = io.connect();
            
            socket.on('connect', function() {
                
            });
            
            socket.on('updateGameBoxes', function(data){
                colourBoxArray = data;
            });
            
            socket.on('networkBoxClicked', networkUpdate);
            
            socket.on('setColour', function(data){
                userColour = data; 
                document.getElementById("colourPreview").style.backgroundColor = userColour;
            });
            
            socket.on('setGameState', function(data){
                gamePlaying = data; 

                var rdyDiv = document.getElementById("readyDiv");
                if(gamePlaying) {rdyDiv.style.visibility = "hidden";}
                else {
                    rdyDiv.style.visibility = "visible";
                    document.getElementById("readyUpBtn").disabled = false;
                }
                
            });
            
            socket.on('updateNumPlayers', function(data){
                numPlayers = data.serverPlayers;
                numPlayersReady = data.serverPlayersReady;
                
                console.log("updating number of players");
                
                document.getElementById("numPlayers").innerHTML = numPlayers;
                document.getElementById("numPlayersReady").innerHTML = numPlayersReady;
            });
            
            socket.on('updateTime', function(data){
                timeLeft = data;
                document.getElementById("timeLeft").innerHTML = timeLeft;
            });
        }
        
        
        function Update(){
            DrawBoxes();
        }
        
        function networkUpdate(data){
            colourBoxArray[data.x][data.y] = data.colour;
        }
        
        function DrawBoxes(){
            
            for(var x = 0; x < 7; x++){
                for(var y = 0; y < 7; y++){
                    
                    var boxColour = colourBoxArray[x][y];
                    ctx.fillStyle = boxColour;
                    ctx.strokeStyle = "#aaa";
                    ctx.lineWidth = 5;
                    
                    ctx.fillRect((boxSize*x), (boxSize*y), boxSize, boxSize);
                    ctx.strokeRect((boxSize*x), (boxSize*y), boxSize, boxSize);
                    
                }
            }
            
        }
        
        function HandleBoxClick(e){ 
            if(gamePlaying){
                var mousePos = GetMousePos(e);
            
                var xPos = Math.floor(mousePos.x/boxSize);
                var yPos = Math.floor(mousePos.y/boxSize);
            
                colourBoxArray[xPos][yPos] = userColour;
            
                socket.emit("clientBoxClick", {
                    colour: userColour,
                    x: xPos,
                    y: yPos
                });
            }
        }
        
        function GetMousePos(e){
            var rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        
        window.onload = init;
    </script>
    
    <style>
        body{
            text-align: center;
        }
        
        #colourPreview{
            width: 25px;
            height: 25px;
            margin: 0 auto;
            margin-top: -20px;
            margin-bottom: 10px;
            border: 2px solid black;
        }
        
        #gameCanvas{
            border: 3px solid #aaa;
        }
    </style>
    
</head>
<body>
    <h1>Colour Me!</h1>
    <h2>Your Color:</h2>
    <div id="colourPreview"></div>
    <h2>Time left in round: <span id="timeLeft">0</span></h2>
    <canvas id="gameCanvas" width="500" height="500" style="background-color: #333;"></canvas>
    <div id="playerInfo">
        <p>Number of current players: <span id="numPlayers"></span></p>
        <div id="readyDiv">
            <p>Players Ready: <span id="numPlayersReady"></span></p>
            <button id="readyUpBtn">Ready Up</button>
        </div>
    </div> 
</body>
</html>

















